global
        log /dev/log local0 info
        log /dev/log local1 notice
        chroot /var/lib/haproxy
        user haproxy
        group haproxy
        daemon

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        option  http-server-close
        option  redispatch
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms

frontend web
        bind 0.0.0.0:80
        redirect scheme https code 301 if !{ ssl_fc }

frontend ssl
        bind 0.0.0.0:443 ssl crt /etc/haproxy/certificate.pem

        # define hosts
        acl host_staging hdr(host) -i staging.nevergreen.io
        acl host_production hdr(host) -i nevergreen.io

        # figure out which one to use
        use_backend staging if host_staging
        use_backend production if host_production

        default_backend production

        # add/remove headers for increased security
        http-response del-header Server
        http-response set-header Strict-Transport-Security "max-age=31536000; includeSubdomains"
        http-response set-header Referrer-Policy "strict-origin"

backend production
        server 1 localhost:3000

backend staging
        server 1 localhost:4000
