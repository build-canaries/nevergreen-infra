global
        log /dev/log local0 info
        log /dev/log local1 notice
        chroot /var/lib/haproxy
        user haproxy
        group haproxy
        daemon
        
        # https://mozilla.github.io/server-side-tls/ssl-config-generator/
        ssl-default-bind-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
        ssl-default-bind-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets
        ssl-default-server-ciphers ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-CHACHA20-POLY1305:ECDHE-RSA-CHACHA20-POLY1305:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA256
        ssl-default-server-options no-sslv3 no-tlsv10 no-tlsv11 no-tls-tickets

defaults
        log     global
        mode    http
        option  httplog
        option  dontlognull
        option  http-server-close
        option  redispatch
        timeout connect 5000ms
        timeout client 50000ms
        timeout server 50000ms

frontend web
        bind 0.0.0.0:80
        redirect scheme https code 301 if !{ ssl_fc }

frontend ssl
        bind 0.0.0.0:443 ssl crt /etc/haproxy/certificate.pem
        http-request redirect prefix https://%[hdr(host),regsub(^www\.,,i)] code 301 if { hdr_beg(host) -i www. }

        # define hosts
        acl host_staging hdr(host) -i staging.nevergreen.io
        acl host_production hdr(host) -i nevergreen.io

        # figure out which one to use
        use_backend staging if host_staging
        use_backend production if host_production

        default_backend production

        # add/remove headers for increased security
        http-response del-header Server
        http-response set-header Strict-Transport-Security "max-age=31536000; includeSubdomains"
        http-response set-header Referrer-Policy "strict-origin"
        http-response set-header Expect-CT "max-age=0; report-uri=\"https://nevergreen.report-uri.io/r/default/ct/reportOnly\""

backend production
        server 1 localhost:3000

backend staging
        server 1 localhost:4000
